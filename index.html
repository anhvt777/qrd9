<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Excel → BIDV QR (local)</title>

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --primary: #006633;
      --accent: #FFC107;
    }
    body { font-family: Arial, sans-serif; margin: 0; background: #f5f6fa; }
    header { background: var(--primary); color: #fff; padding: 16px; text-align: center; }
    #qrs { display: flex; flex-wrap: wrap; gap: 14px; padding: 16px; }
    .qr-item { background: #fff; padding: 10px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,.06); text-align: center; max-width: 300px; }
    .meta { font-size: 13px; line-height: 1.3; margin-bottom: 8px; }
    button { background: var(--primary); color: #fff; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; }
  </style>
</head>
<body>
<header>
  <h2>Tạo QR BIDV từ Excel</h2>
  <input id="upload" type="file" accept=".xlsx,.xls"/>
  <button id="downloadAll">⬇ Tải tất cả (ZIP)</button>
</header>

<div id="qrs"></div>

<script>
let allData = [];
let currentLogoDataUrl = null;

// Màu lấy từ CSS variable
function getCssVar(name) {
  return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
}
const COLOR_PRIMARY = getCssVar("--primary");
const COLOR_ACCENT  = getCssVar("--accent");

document.getElementById("upload").addEventListener("change", handleFile);
document.getElementById("downloadAll").addEventListener("click", onDownloadAll);

function handleFile(e) {
  const f = e.target.files[0];
  if (!f) return;
  const reader = new FileReader();
  reader.onload = evt => {
    const wb = XLSX.read(new Uint8Array(evt.target.result), { type: "array" });
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

    allData = [];
    for (let i = 1; i < rows.length; i++) {
      const r = rows[i];
      if (!r || !r.length) continue;
      allData.push({
        AccountNumber: r[0],
        Bank: r[1] || "BIDV",
        Amount: r[2],
        AccountName: r[3] || "",
        filename: `qr_${r[0]}.png`
      });
    }
    renderList(allData);
  };
  reader.readAsArrayBuffer(f);
}

function renderList(list) {
  const container = document.getElementById("qrs");
  container.innerHTML = "";
  list.forEach(item => {
    const card = document.createElement("div");
    card.className = "qr-item";
    card.innerHTML = `
      <div class="meta">
        <b>${item.AccountName}</b><br/>
        ${item.AccountNumber} (${item.Bank})<br/>
        Amount: ${item.Amount}
      </div>
    `;
    const btn = document.createElement("button");
    btn.textContent = "⬇ Lưu ảnh";
    btn.onclick = async () => {
      const blob = await generateFinalImageBlob(item);
      saveAs(blob, item.filename);
    };
    card.appendChild(btn);
    container.appendChild(card);
  });
}

async function generateFinalImageBlob(item) {
  const size = 350;
  const border = 20;

  // Tạo QR tạm
  const temp = document.createElement("div");
  new QRCode(temp, {
    text: JSON.stringify(item),
    width: size,
    height: size,
    colorDark: "#000",
    colorLight: "#fff",
    correctLevel: QRCode.CorrectLevel.H
  });
  await new Promise(r => setTimeout(r, 50));
  const imgOrCanvas = temp.querySelector("img") || temp.querySelector("canvas");
  const dataUrl = imgOrCanvas.tagName === "IMG" ? imgOrCanvas.src : imgOrCanvas.toDataURL();

  const qrImg = new Image();
  qrImg.src = dataUrl;
  await qrImg.decode();

  // Canvas chính
  const extra = 160;
  const canvas = document.createElement("canvas");
  canvas.width = size + border*2;
  canvas.height = size + border*2 + extra;
  const ctx = canvas.getContext("2d");

  // nền
  ctx.fillStyle = "#fff";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // QR
  ctx.drawImage(qrImg,border,border,size,size);

  // Logo BIDV mặc định
  const logo = new Image();
  logo.src="https://upload.wikimedia.org/wikipedia/commons/6/68/Logo_BIDV.png";
  await logo.decode();
  const lw = 80, lh = 40;
  ctx.drawImage(logo, border+size/2-lw/2, border+size/2-lh/2, lw, lh);

  // Text
  ctx.fillStyle = COLOR_PRIMARY;
  ctx.font = "18px Arial";
  ctx.textAlign = "center";
  ctx.fillText(`Số tiền: ${item.Amount}`, canvas.width/2, size+border+30);
  ctx.fillText(`Tên TK: ${item.AccountName}`, canvas.width/2, size+border+55);
  ctx.fillText(`Số TK: ${item.AccountNumber}`, canvas.width/2, size+border+80);
  ctx.font = "bold 16px Arial";
  ctx.fillText("Liên hệ: Mr AnhVT 0987246777", canvas.width/2, size+border+110);

  return new Promise(res => canvas.toBlob(res, "image/png"));
}

async function onDownloadAll() {
  if (!allData.length) return;
  const zip = new JSZip();
  let count=0;
  for (const item of allData) {
    const blob = await generateFinalImageBlob(item);
    zip.file(item.filename, blob);
    count++;
  }
  const content = await zip.generateAsync({ type: "blob" });
  saveAs(content,"all_bidv_qr_codes.zip");
}
</script>
</body>
</html>
