<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>Excel → QR BIDV Custom</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding:20px; background:#f5f6fa; }
    #preview { display:grid; grid-template-columns: repeat(auto-fill,minmax(320px,1fr)); gap:20px; }
    .card { background:#fff; padding:20px; border-radius:20px; box-shadow:0 4px 12px rgba(0,0,0,0.1); text-align:center }
    canvas { max-width:100%; height:auto; }
  </style>
</head>
<body>
  <h2>Tạo QR BIDV từ Excel</h2>
  <input type="file" id="excelFile" accept=".xlsx,.xls"/>
  <button id="downloadZip">Download ZIP</button>
  <div id="preview"></div>

<script>
const preview = document.getElementById("preview");
let generated = []; // lưu canvas để zip

document.getElementById("excelFile").addEventListener("change", handleFile, false);

async function handleFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  const data = await file.arrayBuffer();
  const workbook = XLSX.read(data);
  const sheet = workbook.Sheets[workbook.SheetNames[0]];
  const rows = XLSX.utils.sheet_to_json(sheet);

  preview.innerHTML = "";
  generated = [];

  for (const row of rows) {
    const account = row["Số TK"] || row["account"] || "";
    const name = row["Tên TK"] || row["name"] || "";
    const amount = row["Số tiền"] || row["amount"] || "";
    const canvas = await generateQR(account, name, amount);
    const card = document.createElement("div");
    card.className = "card";
    card.appendChild(canvas);
    preview.appendChild(card);
    generated.push({canvas, filename: `${account}_${name}.png`});
  }
}

async function generateQR(account, name, amount) {
  const size = 400;
  // generate QR data
  const temp = document.createElement("div");
  new QRCode(temp, {
    text: JSON.stringify({account, name, amount}),
    width: size, height: size,
    colorDark:"#000000", colorLight:"#ffffff",
    correctLevel: QRCode.CorrectLevel.H
  });
  await new Promise(r => setTimeout(r,50));
  const qrImg = temp.querySelector("img") || temp.querySelector("canvas");
  const dataUrl = qrImg.tagName.toLowerCase()==="img" ? qrImg.src : qrImg.toDataURL();
  const img = new Image(); img.src = dataUrl; await img.decode();

  const extraHeight = 160;
  const canvas = document.createElement("canvas");
  canvas.width = size+40;
  canvas.height = size+extraHeight;
  const ctx = canvas.getContext("2d");

  // nền bo tròn
  roundRect(ctx,0,0,canvas.width,canvas.height,20);
  ctx.fillStyle="#ffffff"; ctx.fill();

  // QR
  ctx.drawImage(img,20,20,size,size);

  // Logo BIDV
  const logo = new Image();
  logo.src="https://upload.wikimedia.org/wikipedia/commons/6/68/Logo_BIDV.png";
  await logo.decode();
  const lw=80, lh=40;
  const lx=(canvas.width-lw)/2, ly=20+size/2-lh/2;
  roundRect(ctx,lx-8,ly-8,lw+16,lh+16,10);
  ctx.fillStyle="#fff"; ctx.fill();
  ctx.drawImage(logo,lx,ly,lw,lh);

  // text info
  ctx.fillStyle="#000";
  ctx.textAlign="center";
  ctx.font="18px Arial";
  ctx.fillText(`Số tiền: ${amount} VND`, canvas.width/2, size+50);
  ctx.fillText(`Tên TK: ${name}`, canvas.width/2, size+75);
  ctx.fillText(`Số TK: ${account}`, canvas.width/2, size+100);
  ctx.font="bold 16px Arial";
  ctx.fillText("Mọi chi tiết liên hệ: Mr AnhVT 0987246777", canvas.width/2, size+130);

  return canvas;
}

function roundRect(ctx,x,y,w,h,r){
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r);
  ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r);
  ctx.arcTo(x,y,x+w,y,r);
  ctx.closePath();
}

document.getElementById("downloadZip").addEventListener("click", async ()=>{
  if (!generated.length) { alert("Chưa có QR nào"); return; }
  const zip=new JSZip();
  for (const g of generated) {
    const blob=await new Promise(res=>g.canvas.toBlob(res,"image/png"));
    zip.file(g.filename,blob);
  }
  const content=await zip.generateAsync({type:"blob"});
  saveAs(content,"QR_BIDV.zip");
});
</script>
</body>
</html>
