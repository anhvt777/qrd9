<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>BIDV Excel → QR</title>

  <!-- Thư viện -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; background:#f5f6fa; padding:20px; }
    h1 { text-align:center; }
    #controls { text-align:center; margin-bottom:20px; }
    #qrs { display:flex; flex-wrap:wrap; gap:20px; justify-content:center; }
    .qr-card {
      background:#fff;
      border-radius:16px;
      box-shadow:0 4px 12px rgba(0,0,0,0.1);
      padding:20px;
      text-align:center;
      width:280px;
    }
    .logo { max-width:140px; margin:0 auto 12px; }
    .qr-frame { margin:0 auto; border-radius:16px; overflow:hidden; padding:10px; background:#fff; }
    .info { margin-top:12px; font-size:15px; line-height:1.4; }
    .highlight { font-weight:bold; color:#006666; }
    .contact { margin-top:10px; font-size:13px; color:#444; }
    button { margin-top:12px; padding:6px 12px; border:none; border-radius:6px; cursor:pointer; background:#0070f3; color:#fff; }
    button:hover { background:#0056b3; }
  </style>
</head>
<body>

<h1>BIDV Excel → QR</h1>
<div id="controls">
  <input type="file" id="upload" accept=".xlsx,.xls" />
  <button id="downloadAll" style="display:none;">⬇ Tải tất cả (ZIP)</button>
</div>
<div id="qrs"></div>

<script>
  let allData = [];

  document.getElementById("upload").addEventListener("change", handleFile, false);
  document.getElementById("downloadAll").addEventListener("click", downloadAll, false);

  function handleFile(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(evt) {
      const data = new Uint8Array(evt.target.result);
      const wb = XLSX.read(data, {type:'array'});
      const sheet = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet, {header:1});
      allData = [];

      for (let i=1; i<rows.length; i++) {
        const row = rows[i];
        if (!row || !row[0]) continue;
        const obj = {
          AccountNumber: row[0],
          AccountName: row[1] || "",
          Amount: row[2] || "",
          Remark: row[3] || ""
        };
        allData.push(obj);
      }
      renderList();
      document.getElementById("downloadAll").style.display = allData.length ? "inline-block" : "none";
    };
    reader.readAsArrayBuffer(file);
  }

  function renderList() {
    const container = document.getElementById("qrs");
    container.innerHTML = "";
    allData.forEach((item, idx) => {
      const card = document.createElement("div");
      card.className = "qr-card";

      // Logo BIDV
      const logo = document.createElement("img");
      logo.src = "_bidvqr1758192361FDNWRSGVXZ.png"; // đổi tên nếu khác
      logo.className = "logo";
      card.appendChild(logo);

      // QR Holder
      const qrDiv = document.createElement("div");
      qrDiv.className = "qr-frame";
      qrDiv.id = "qr_"+idx;
      card.appendChild(qrDiv);

      // Info
      const info = document.createElement("div");
      info.className = "info";
      info.innerHTML = `
        Số tiền: <span class="highlight">${item.Amount}</span><br>
        Tên tài khoản: <span class="highlight">${item.AccountName}</span><br>
        Số tài khoản: <span class="highlight">${item.AccountNumber}</span>
      `;
      card.appendChild(info);

      const contact = document.createElement("div");
      contact.className = "contact";
      contact.textContent = "Mọi chi tiết liên hệ: Mr AnhVT 0987246777";
      card.appendChild(contact);

      // Nút tải riêng
      const btn = document.createElement("button");
      btn.textContent = "⬇ Tải ảnh này";
      btn.addEventListener("click", ()=>downloadOne(idx, item));
      card.appendChild(btn);

      container.appendChild(card);

      // Tạo QR
      const qrText = JSON.stringify(item);
      new QRCode(qrDiv, {
        text: qrText,
        width: 220,
        height: 220,
        colorDark:"#000000",
        colorLight:"#ffffff",
        correctLevel: QRCode.CorrectLevel.H
      });
    });
  }

  async function downloadOne(idx, item) {
    const card = document.querySelectorAll(".qr-card")[idx];
    const canvas = await htmlToCanvas(card);
    canvas.toBlob(blob=>{
      saveAs(blob, `qr_${item.AccountNumber}.png`);
    });
  }

  async function downloadAll() {
    const zip = new JSZip();
    for (let i=0;i<allData.length;i++) {
      const item = allData[i];
      const card = document.querySelectorAll(".qr-card")[i];
      const canvas = await htmlToCanvas(card);
      const blob = await new Promise(res=>canvas.toBlob(res,"image/png"));
      zip.file(`qr_${item.AccountNumber}.png`, blob);
    }
    const content = await zip.generateAsync({type:"blob"});
    saveAs(content,"all_qr_codes.zip");
  }

  // Convert một element thành canvas (dùng html2canvas)
  async function htmlToCanvas(element) {
    return await html2canvas(element,{backgroundColor:null});
  }
</script>

<!-- html2canvas để chụp DOM thành ảnh -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

</body>
</html>
